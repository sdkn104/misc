# AuthServer - 設計書

## 1. システムアーキテクチャ

### 1.1 全体構成図

```
┌─────────────────────────────────────────────────────────┐
│                    Active Directory                      │
│              (Windows Domain Authentication)             │
└────────────────────────┬────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
   ┌────▼────┐      ┌────▼────┐     ┌────▼────┐
   │  Client │      │   IIS    │     │External │
   │ Browser │      │ AppPool  │     │Programs │
   │(Dify)   │      └────┬─────┘     └────┬────┘
   └────┬────┘           │                 │
        │                │                 │
        └────────────────┼─────────────────┘
                         │
                ┌────────▼────────┐
                │   AuthServer    │
                │  (ASP.NET Core) │
                │                 │
                ├─────────────────┤
                │ Controllers:    │
                │ - DifyApp       │
                │ - LogAPI        │
                └────────┬────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
    ┌────▼────┐   ┌─────▼──────┐  ┌────▼────┐
    │ Logging │   │ CORS Policy│  │ Session │
    │ (Serilog)   │            │  │Management
    └─────────┘   └────────────┘  └─────────┘
         │
    ┌────▼──────────┐
    │  Log Files    │
    │ (50MB rolling)│
    └───────────────┘
```

### 1.2 コンポーネント説明

| コンポーネント | 説明 |
|-----------|------|
| DifyAppController | Difyアプリケーションをiframeで埋め込むコントローラー |
| LogController | ログ記録APIを提供するコントローラー |
| Serilog | 構造化ログ出力ライブラリ |
| Negotiate Authentication | Windows認証を実行 |
| CORS Middleware | クロスオリジンリクエストを制御 |

---

## 2. 機能設計

### 2.1 DifyApp機能

#### エンドポイント
- **URL**: `/difyApp/{path}`
- **メソッド**: GET
- **認証**: Windows認証（Negotiate）
- **説明**: リクエストのパスパラメータからDifyアプリのURLを特定し、iframeで埋め込む

#### 処理フロー
```
1. クライアントリクエスト受信
   ↓
2. Windows認証実行 → ユーザー名取得
   ↓
3. パスパラメータを解析 (例: chatbot/KtFo2mI15fIkZ7lr)
   ↓
4. Dify BaseURLと結合
   (http://dify.example.com/chatbot/KtFo2mI15fIkZ7lr)
   ↓
5. HTMLテンプレート生成（iframeでDifyアプリを埋め込む）
   ↓
6. アクセスログ出力（Serilog）
   ↓
7. HTMLレスポンス返却
```

#### 出力されるログ例
```
2024-12-26 14:30:45 [INF] User:DOMAIN\username | URL:/difyApp/chatbot/KtFo2mI15fIkZ7lr | Status:200 | IP:192.168.1.100 |
```

### 2.2 Log API機能

#### エンドポイント

##### GET版
- **URL**: `/api/log/{name}?message={message}`
- **メソッド**: GET
- **パラメータ**:
  - `name` (Path): ログ識別名（呼び出し元指定）
  - `message` (Query): ログメッセージ（オプション）
- **認証**: Windows認証
- **レスポンス**: `{"status":"success", "message":"Log recorded successfully"}`

##### POST版
- **URL**: `/api/log/{name}`
- **メソッド**: POST
- **Content-Type**: `application/json`
- **ボディ例**:
  ```json
  {
    "message": "Processing completed",
    "metadata": "Additional information"
  }
  ```
- **認証**: Windows認証
- **レスポンス**: `{"status":"success", "message":"Log recorded successfully"}`

#### 処理フロー
```
1. APIリクエスト受信
   ↓
2. Windows認証実行
   ↓
3. ログパラメータ抽出（name, message, metadata）
   ↓
4. ログファイルに出力（Serilog）
   - ログ名
   - メッセージ
   - ユーザー名
   - IPアドレス
   - 日時（自動）
   ↓
5. JSONレスポンス返却
```

### 2.3 ログ機能

#### ログ出力仕様

**ログレベル**: Information（標準出力）

**ログフォーマット**:
```
{Timestamp:yyyy-MM-dd HH:mm:ss} [{Level:u3}] User:{User} | URL:{RequestPath}{QueryString} | Status:{StatusCode} | IP:{RemoteIpAddress} | {Message:lj}
```

**ログ出力項目**:
| 項目 | 説明 | 例 |
|------|------|-----|
| Timestamp | アクセス日時 | 2024-12-26 14:30:45 |
| Level | ログレベル | INF, WRN, ERR |
| User | ユーザー名 | DOMAIN\username |
| URL | アクセスURL+クエリ文字列 | /api/log/test?message=hello |
| Status | HTTPステータスコード | 200, 404, 500 |
| RemoteIpAddress | クライアントIPアドレス | 192.168.1.100 |
| Message | ログメッセージ | Custom message |

**ログファイル管理**:
- **出力先**: `{ApplicationDirectory}/logs/access-{Date}.txt`
- **ローテーション**: 無制限（ファイルサイズベース）
- **サイズリミット**: 50MB（52,428,800バイト）
- **古いファイル保持数**: 無制限
- **ローテーション方式**: RollingInterval.Infinite（日次回転ではなくサイズベース）

#### ログ出力例
```
2024-12-26 14:30:45 [INF] User:DOMAIN\john.doe | URL:/difyApp/chatbot/KtFo2mI15fIkZ7lr | Status:200 | IP:192.168.1.100 |
2024-12-26 14:31:12 [INF] User:DOMAIN\jane.smith | URL:/api/log/batch-process?message=started | Status:200 | IP:192.168.1.101 |
2024-12-26 14:31:45 [INF] LogName:DataSync | Message:10000 records processed | Metadata: | User:DOMAIN\system | IP:10.0.0.5 |
```

### 2.4 CORS設定

#### 設定方針
- Difyアプリを複数の外部ホストから呼び出せるようにする
- CORSは明示的に許可されたオリジンのみを許可

#### appsettings.jsonでの設定例
```json
"Cors": {
  "AllowedOrigins": [
    "http://localhost:3000",
    "https://dify.example.com"
  ]
}
```

#### 許可する内容
- **オリジン**: appsettings.jsonで設定
- **メソッド**: すべて（GET, POST, PUT, DELETE等）
- **ヘッダー**: すべて
- **認証情報**: 設定に応じて

---

## 3. 認証設計

### 3.1 Windows認証（Negotiate）

**使用技術**: 
- `Microsoft.AspNetCore.Authentication.Negotiate`
- HTTPの仕様に従ったネゴシエーション認証

**認証フロー**:
```
1. クライアント → AuthServer (初回リクエスト)
   ↓
2. AuthServer → クライアント (WWW-Authenticate: Negotiate)
   ↓
3. クライアント → AuthServer (認証トークン付き)
   ↓
4. 認証成功 → User.Identity.Name取得
```

**取得可能な情報**:
- `User.Identity.Name`: "DOMAIN\username" 形式

### 3.2 認可設定

**対象エンドポイント**:
- `/difyApp/*`: `[Authorize]` 属性で保護
- `/api/log/*`: `[Authorize]` 属性で保護

**パブリックエンドポイント**: なし（全エンドポイント認証必須）

---

## 4. データベース設計

本システムではデータベースは使用しない。
すべてのログはファイルに出力される（Serilog）。

---

## 5. セキュリティ設計

### 5.1 認証セキュリティ
- Active Directoryのドメイン認証を利用
- 強力なドメインパスワードポリシーに従う

### 5.2 通信セキュリティ
- HTTPS必須（IIS設定）
- 自己署名証明書または公式証明書使用

### 5.3 ログセキュリティ
- ログファイルは機密情報を含むため、IISアプリケーションプール アイデンティティ以上の権限で保護
- ログディレクトリへのアクセス制限

### 5.4 CORS セキュリティ
- appsettings.jsonで許可されたオリジンのみ許可
- ワイルドカード（*）の使用は避ける

---

## 6. パフォーマンス設計

### 6.1 スケーラビリティ
- **ログローテーション**: ファイルサイズ 50MB ごと
- **ログ保持**: 古いファイル無制限保持（ディスク容量による）
- **同時接続**: IISの設定に依存

### 6.2 キャッシング
- 現在のバージョンではキャッシュ機構なし
- Dify Appのレスポンスはブラウザキャッシュに依存

---

## 7. 運用設計

### 7.1 ログ監視
- ログファイルをテキストエディタまたはログビューアで監視
- 50MBごとにローテーションされるため、古いログの保管方法を決定

### 7.2 トラブルシューティング
- **認証失敗**: Active Directoryの接続確認
- **ログ出力失敗**: ディスク容量確認、ファイルパーミッション確認
- **CORS エラー**: appsettings.jsonのAllowedOrigins確認

### 7.3 設定変更
- `appsettings.json`を編集後、IISでアプリケーションプールを再起動

---

## 8. 開発・デプロイメント環境

### 8.1 開発環境
- **OS**: Windows 10/11
- **.NET**: .NET 8.0
- **IDE**: Visual Studio 2022 または Visual Studio Code
- **Dify**: ローカルホスト（http://localhost:8000推奨）

### 8.2 本番環境
- **OS**: Windows Server 2019 以上
- **.NET Runtime**: .NET 8.0 Hosting Bundle
- **IIS**: IIS 10.0 以上
- **Dify**: リモートホスト
- **SSL証明書**: 公式証明書推奨

---

## 9. 構成情報

### 9.1 プロジェクト構成
```
AuthServer/
├── Program.cs                      # アプリケーション起動ポイント
├── appsettings.json               # 本番設定
├── appsettings.Development.json   # 開発環境設定
├── AuthServer.csproj              # プロジェクトファイル
└── Controllers/
    ├── DifyAppController.cs       # Difyアプリ機能
    └── LogController.cs           # ログAPI機能
```

### 9.2 重要な設定項目
```json
{
  "Dify": {
    "BaseUrl": "http://dify.example.com"  // 変更容易な設計
  },
  "Cors": {
    "AllowedOrigins": [...]  // セキュリティポイント
  }
}
```

---

## 10. 将来の拡張ポイント

1. **データベース統合**: ログをSQL Serverに保存
2. **ログ検索UI**: Webベースのログ検索機能
3. **ユーザー管理**: ユーザー権限管理
4. **監査ログ**: 管理者操作のログ記録
5. **通知機能**: エラーログ時のメール通知
