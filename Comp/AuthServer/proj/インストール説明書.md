# AuthServer - インストール説明書

## 1. システム要件

### 1.1 ハードウェア要件
- **プロセッサ**: Intel Xeon または同等以上（1GHz以上）
- **メモリ**: 最小 2GB（推奨 4GB）
- **ディスク**: 最小 500MB（ログ保存用に追加容量が必要）

### 1.2 ソフトウェア要件

#### OS
- Windows Server 2019 以上（推奨：Windows Server 2022）
- または Windows 10/11（開発環境用）

#### .NET Runtime
- .NET 8.0 Hosting Bundle
  - ダウンロード: https://dotnet.microsoft.com/download/dotnet/8.0
  - ファイル: `dotnet-hosting-8.0.x-win.exe`

#### IIS
- IIS 10.0 以上
- 必須モジュール:
  - .NET Core Runtime Support (インストーラーで自動)
  - Windows Authentication
  - Application Initialization

#### Active Directory
- 導入企業のドメイン環境

---

## 2. 開発環境セットアップ

### 2.1 前提条件

- Visual Studio 2022 または Visual Studio Code
- .NET 8.0 SDK
- Git（バージョン管理用）

### 2.2 インストール手順

#### ステップ 1: .NET 8.0 SDKのインストール

1. https://dotnet.microsoft.com/download/dotnet/8.0 にアクセス
2. **"Download .NET SDK"** をクリック
3. **`dotnet-sdk-8.0.x-win-x64.exe`** をダウンロード
4. インストーラーを実行
5. デフォルト設定で完了

**確認**:
```powershell
dotnet --version
# 出力例: 8.0.x
```

#### ステップ 2: プロジェクトクローン

```powershell
cd d:\NoSync\misc\Comp\AuthServer
git clone <repository-url> proj
# または手動でprojフォルダにファイルをコピー
```

#### ステップ 3: 依存パッケージの復元

```powershell
cd d:\NoSync\misc\Comp\AuthServer\proj
dotnet restore
```

**期待される出力**:
```
Restore completed in 5.23 sec for d:\NoSync\misc\Comp\AuthServer\proj\AuthServer.csproj.
```

#### ステップ 4: 開発環境設定の確認

`appsettings.Development.json` を確認:

```json
{
  "Dify": {
    "BaseUrl": "http://localhost:8000"
  },
  "Cors": {
    "AllowedOrigins": [
      "http://localhost:3000",
      "http://localhost:8000"
    ]
  }
}
```

#### ステップ 5: アプリケーション実行

```powershell
dotnet run
```

**期待される出力**:
```
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5000
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to exit.
```

#### ステップ 6: 動作確認

ブラウザで以下にアクセス:

- **Swagger UI**: `http://localhost:5000/swagger/index.html`
- **Dify App**: `http://localhost:5000/difyApp/chatbot/test`（Windows認証で）
- **Log API**: `http://localhost:5000/api/log/test?message=hello`（Windows認証で）

---

## 3. 本番環境セットアップ

### 3.1 環境構築（IIS)

#### ステップ 1: IISのインストール

PowerShell (管理者) で実行:

```powershell
Enable-WindowsOptionalFeature -Online -FeatureName IIS-WebServerRole
Enable-WindowsOptionalFeature -Online -FeatureName IIS-WebServer
Enable-WindowsOptionalFeature -Online -FeatureName IIS-CommonHttpFeatures
Enable-WindowsOptionalFeature -Online -FeatureName IIS-StaticContent
Enable-WindowsOptionalFeature -Online -FeatureName IIS-DefaultDocument
Enable-WindowsOptionalFeature -Online -FeatureName IIS-DirectoryBrowsing
Enable-WindowsOptionalFeature -Online -FeatureName IIS-HttpErrors
Enable-WindowsOptionalFeature -Online -FeatureName IIS-ApplicationDevelopment
Enable-WindowsOptionalFeature -Online -FeatureName IIS-ASPNET45
Enable-WindowsOptionalFeature -Online -FeatureName IIS-NetFxExtensibility45
Enable-WindowsOptionalFeature -Online -FeatureName IIS-HealthAndDiagnostics
Enable-WindowsOptionalFeature -Online -FeatureName IIS-HttpLogging
Enable-WindowsOptionalFeature -Online -FeatureName IIS-Security
Enable-WindowsOptionalFeature -Online -FeatureName IIS-WindowsAuthentication
Enable-WindowsOptionalFeature -Online -FeatureName IIS-RequestFiltering
Enable-WindowsOptionalFeature -Online -FeatureName IIS-Performance
Enable-WindowsOptionalFeature -Online -FeatureName IIS-ApplicationInit
```

**確認**:
```powershell
iisreset
# IISが正常に起動することを確認
```

#### ステップ 2: .NET 8.0 Hosting Bundleのインストール

1. https://dotnet.microsoft.com/download/dotnet/8.0 にアクセス
2. **"Hosting Bundle"** をダウンロード（`dotnet-hosting-8.0.x-win.exe`）
3. 管理者として実行
4. デフォルト設定でインストール

**確認** (PowerShell 再起動後):
```powershell
dotnet --info
# Runtime version が表示されることを確認
```

### 3.2 アプリケーションのデプロイ

#### ステップ 1: アプリケーションの公開

```powershell
cd d:\NoSync\misc\Comp\AuthServer\proj
dotnet publish -c Release -o "C:\inetpub\wwwroot\authserver"
```

**確認**:
```powershell
dir "C:\inetpub\wwwroot\authserver"
# AuthServer.dllなどが表示されることを確認
```

#### ステップ 2: ログディレクトリの作成

```powershell
New-Item -ItemType Directory -Path "C:\inetpub\wwwroot\authserver\logs" -Force
```

#### ステップ 3: IIS マネージャーでサイトを作成

1. **IIS マネージャー**を起動
2. 左側ツリーから **"Sites"** を右クリック
3. **"Add Website"** を選択
4. 以下を設定:

| 項目 | 値 |
|------|-----|
| Site name | AuthServer |
| Application pool | AuthServer（新規作成） |
| Physical path | C:\inetpub\wwwroot\authserver |
| Binding Type | https |
| IP address | * (All Unassigned) |
| Port | 443 |
| SSL certificate | 有効な証明書を選択 |

#### ステップ 4: アプリケーション プールの設定

1. **Application Pools** から **"AuthServer"** を選択
2. 右側 **"Basic Settings"** を開く
3. 以下を設定:

| 項目 | 値 |
|------|-----|
| .NET CLR version | No Managed Code |
| Managed pipeline mode | Integrated |
| Identity | ApplicationPoolIdentity |

#### ステップ 5: 認証の有効化

1. **Sites > AuthServer** を選択
2. 中央パネルから **"Authentication"** をダブルクリック
3. 以下を設定:

| 認証方式 | 状態 |
|---------|------|
| Anonymous Authentication | 無効 |
| Windows Authentication | 有効 |
| Forms Authentication | 無効 |

#### ステップ 6: ファイアウォール設定

PowerShell (管理者) で実行:

```powershell
# IISの受信トラフィックを許可
New-NetFirewallRule -DisplayName "IIS HTTPS" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 443
New-NetFirewallRule -DisplayName "IIS HTTP" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 80
```

### 3.3 設定ファイルの更新

`appsettings.json` を本番環境用に更新:

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Dify": {
    "BaseUrl": "https://dify.example.com"
  },
  "Cors": {
    "AllowedOrigins": [
      "https://dify.example.com",
      "https://yourapp.example.com"
    ]
  }
}
```

**重要**: 
- `BaseUrl`: 実際のDifyホストのURLに変更
- `AllowedOrigins`: 許可するオリジンのみ設定

### 3.4 ログディレクトリのアクセス権設定

PowerShell (管理者) で実行:

```powershell
# IIS アプリケーション プール アイデンティティにアクセス権を付与
$path = "C:\inetpub\wwwroot\authserver\logs"
$user = "IIS AppPool\AuthServer"

$acl = Get-Acl $path
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule(
    $user,
    "Modify",
    "ContainerInherit,ObjectInherit",
    "None",
    "Allow"
)
$acl.AddAccessRule($rule)
Set-Acl -Path $path -AclObject $acl
```

### 3.5 サイト起動と確認

1. IIS マネージャーから **"AuthServer"** サイトを右クリック
2. **"Start"** を選択
3. ブラウザで `https://authserver.example.com/difyApp/chatbot/test` にアクセス
4. Windows認証でログイン

---

## 4. トラブルシューティング

### 4.1 認証エラー

**症状**: 401 Unauthorized エラー

**解決方法**:
1. IISの認証設定を確認
   ```
   IIS Manager > Sites > AuthServer > Authentication
   → Windows Authentication が有効か確認
   ```
2. クライアントマシンがドメインに参加しているか確認
3. プロキシサーバーを経由している場合は設定を確認

### 4.2 ログファイルが作成されない

**症状**: `logs/` ディレクトリにファイルが出力されない

**解決方法**:
1. ディレクトリが存在するか確認
   ```powershell
   Test-Path "C:\inetpub\wwwroot\authserver\logs"
   ```
2. アクセス権を確認
   ```powershell
   icacls "C:\inetpub\wwwroot\authserver\logs"
   ```
3. ディスク容量を確認
   ```powershell
   Get-Volume C
   ```
4. IIS ログを確認
   ```
   C:\inetpub\logs\LogFiles\W3SVC1\
   ```

### 4.3 Dify App がロードされない

**症状**: iframeが空白

**解決方法**:
1. `appsettings.json` の `Dify:BaseUrl` を確認
2. Difyサーバーへの接続を確認
   ```powershell
   Test-NetConnection -ComputerName dify.example.com -Port 80
   ```
3. CORS設定を確認
   ```json
   "Cors": {
     "AllowedOrigins": ["https://dify.example.com"]
   }
   ```

### 4.4 HTTPS接続エラー

**症状**: "この接続は隠されていません" (NET::ERR_CERT_INVALID)

**解決方法**:
1. SSL証明書が正しくインストールされているか確認
   ```
   IIS Manager > Server Certificates
   ```
2. バインディングが正しいか確認
   ```
   IIS Manager > Sites > AuthServer > Bindings
   → HTTPS バインディングでSSL証明書が選択されているか
   ```
3. 自己署名証明書の場合、クライアントで信頼を追加

### 4.5 パフォーマンスの問題

**症状**: 応答が遅い

**解決方法**:
1. アプリケーション プールがアイドル状態で回収されていないか確認
   ```
   IIS Manager > Application Pools > AuthServer > Advanced Settings
   → "Idle Time-out" を 0 に設定（回収を無効）
   ```
2. ログファイルのサイズを確認
   ```powershell
   Get-ChildItem "C:\inetpub\wwwroot\authserver\logs" | Measure-Object -Sum Length
   ```
3. IISのオブジェクトキャッシュを確認
   ```
   IIS Manager > Server > Output Caching > Edit Feature Settings
   ```

---

## 5. 運用手順

### 5.1 日常的な監視

毎日、ログファイルをチェック:

```powershell
# 最新のログファイルを表示
Get-ChildItem "C:\inetpub\wwwroot\authserver\logs" | Sort-Object LastWriteTime -Descending | Select-Object -First 1 | Get-Content -Tail 50
```

### 5.2 ログファイルのアーカイブ

30日以上古いログファイルをバックアップ:

```powershell
$logPath = "C:\inetpub\wwwroot\authserver\logs"
$archivePath = "C:\backup\authserver-logs"
$cutoffDate = (Get-Date).AddDays(-30)

Get-ChildItem $logPath -Filter "access-*.txt" | Where-Object { $_.LastWriteTime -lt $cutoffDate } | Move-Item -Destination $archivePath
```

**スケジュール**: Windowsタスクスケジューラで毎週実行

### 5.3 アプリケーション更新

```powershell
# 1. 新しいコードをビルド
dotnet publish -c Release -o "C:\inetpub\wwwroot\authserver-new"

# 2. サイトを停止
iisreset /stop

# 3. ディレクトリを切り替え
Rename-Item "C:\inetpub\wwwroot\authserver" "authserver-old"
Rename-Item "C:\inetpub\wwwroot\authserver-new" "authserver"

# 4. サイトを起動
iisreset /start

# 5. 動作確認後、古いディレクトリを削除
Remove-Item "C:\inetpub\wwwroot\authserver-old" -Recurse
```

### 5.4 セッションのリセット

アプリケーション プールの回収（メモリ開放）:

```powershell
# IIS マネージャーから
# Application Pools > AuthServer > Recycle...

# またはコマンドラインから
iisreset /app:AuthServer /restart
```

---

## 6. セキュリティチェックリスト

デプロイ前に以下を確認してください：

- [ ] SSL証明書が有効期限内か確認
- [ ] HTTPS通信が強制されているか確認
- [ ] `appsettings.json` の `AllowedOrigins` が適切に設定されているか
- [ ] ログディレクトリへのアクセス権が適切か
- [ ] ファイアウォール設定が完了しているか
- [ ] 不要なポート（HTTP 80など）を無効にしたか
- [ ] IISの "Directory Browsing" が無効か確認
- [ ] Default Document が適切に設定されているか

---

## 7. バックアップと災害復旧

### 7.1 IIS設定のバックアップ

```powershell
# IIS設定全体をバックアップ
$backupName = "AuthServer-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
$backupPath = "C:\backup\$backupName"

# IIS Configuration のバックアップディレクトリ
Copy-Item "C:\inetpub\history" $backupPath -Recurse
Copy-Item "C:\Windows\System32\inetsrv\config" "$backupPath\iis-config" -Recurse
```

### 7.2 設定復旧

```powershell
# IIS設定を復旧
Copy-Item "$backupPath\iis-config\*" "C:\Windows\System32\inetsrv\config" -Recurse -Force
iisreset
```

---

## 8. サポート連絡先

問題が発生した場合:

1. ログファイルを確認: `C:\inetpub\wwwroot\authserver\logs\`
2. IISログを確認: `C:\inetpub\logs\LogFiles\`
3. Windowsイベントログを確認: `eventvwr.msc`
4. サポートチームに以下を添付：
   - エラーが発生した日時
   - 該当するログファイル（14日分）
   - IISエラーログ
   - Windowsイベントログ（Application, Security）

---

## 付録: クイックリファレンス

### PowerShellコマンド集

```powershell
# IIS再起動
iisreset

# アプリケーション プール停止
Stop-WebAppPool -Name "AuthServer"

# アプリケーション プール起動
Start-WebAppPool -Name "AuthServer"

# サイト状態確認
Get-WebSite | Where-Object { $_.Name -eq "AuthServer" }

# バインディング確認
Get-WebBinding -Name "AuthServer"

# ログファイルの行数をカウント
(Get-Content "C:\inetpub\wwwroot\authserver\logs\access-*.txt" | Measure-Object -Line).Lines
```

### 設定ファイルテンプレート

**appsettings.Production.json**:
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Dify": {
    "BaseUrl": "https://dify.example.com"
  },
  "Cors": {
    "AllowedOrigins": [
      "https://dify.example.com"
    ]
  }
}
```
