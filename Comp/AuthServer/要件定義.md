# AuthServer - 要件定義書

## 1. プロジェクト概要

AuthServerは、Microsoft Active Directoryドメイン環境で動作するWebアプリ/APIで、
別途作成したアプリやプログラムに対して、Windows認証によるログの機能を提供することを目的とする。

### 1.1 目的
- Difyで作成したWebアプリに対して、Windows認証によるログ出力機能を提供する。
- 別途作成したプログラムに対して、Windows認証によるログ出力機能を提供する。

## 2. 機能要件

### 2.1 Difyアプリのフロントエンド機能

- 本機能はWebアプリであり、単一の画面を有する。

- 本機能のエンドポイント: /difyApp/[path]?message=[message]
    - [path]はDifyのパス
    - [message]はアクセス元が指定する自由な文字列

- 単一の画面には、Difyで作成したWebアプリの画面を埋め込む。
- リクエストのパス[path]から以下の例のように埋め込むDifyアプリのURLを特定する。
    - リクエスト:  /difyApp/chatbot/KtFo2mI15fIkZ7lr
    - Dify app: http://dify.example.com/chatbot/KtFo2mI15fIkZ7lr
- 上記のDify appのホスト部分(http://dify.com/)は変更が容易になるようにする

- Windows認証を実施してユーザ名を取得し、ユーザ名を含むアクセスログをファイルに出力する。
    - 出力仕様は2.3節に示す。

#### 2.2 ログ記録API機能

- ログを記録するWeb API

- 本機能のエンドポイント: /api/log/[name]?message=[message]
    - [name]はアクセス元が指定する自由な名前
    - [message]はアクセス元が指定する自由な文字列

- 外部プログラムからのAPIの呼び出しに対して、下記の2.3項の仕様でアクセスログをファイルに出力する。
- CORSを特定のアクセス元に対して許可する

- Windows認証を実施してユーザ名を取得し、ユーザ名を含むアクセスログをファイルに出力する。
    - 出力仕様は2.3節に示す。

#### 2.3 ログ機能

- アクセスログは以下の情報を含む。
    - アクセス日時
    - ユーザ名
    - アクセスURL(query stringも含む)
    - レスポンスステータス
    - アクセス元IPアドレス
    - その他、通常のWeb appのアクセスログに出力する内容

- ログファイルはサイズ制限(50MB)を設けて複数ファイルにローテーションする。
  (日次のローテーションはしない)

## 4. 技術スタック

- ASP.NET Core
- IIS

## 5. 生成の指示

- projという名前のフォルダを作成し、すべての生成物はその下に配置する
